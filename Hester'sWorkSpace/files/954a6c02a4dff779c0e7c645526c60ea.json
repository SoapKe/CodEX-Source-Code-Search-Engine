{"author": "ansible", "code": "\n  Copyright (c) 2017 Citrix Systems\n\n This file is part of Ansible\n\n Ansible is free software: you can redistribute it and/or modify\n it under the terms of the GNU General Public License as published by\n the Free Software Foundation, either version 3 of the License, or\n (at your option) any later version.\n\n Ansible is distributed in the hope that it will be useful,\n but WITHOUT ANY WARRANTY; without even the implied warranty of\n MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n GNU General Public License for more details.\n\n You should have received a copy of the GNU General Public License\n along with Ansible.  If not, see <http://www.gnu.org/licenses/>.\n\n\nfrom ansible.compat.tests.mock import patch, Mock, MagicMock, call\nfrom units.modules.utils import set_module_args\nfrom .netscaler_module import TestModule, nitro_base_patcher\n\nimport sys\n\nif sys.version_info[:2] != (2, 6):\n    import requests\n\n\nclass TestNetscalerLBVServerModule(TestModule):\n\n    @classmethod\n    def setUpClass(cls):\n        class MockException(Exception):\n            pass\n\n        cls.MockException = MockException\n\n        m = MagicMock()\n        cls.server_mock = MagicMock()\n        cls.server_mock.__class__ = MagicMock(add=Mock())\n        nssrc_modules_mock = {\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver.lbvserver': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_service_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_service_binding.lbvserver_service_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_servicegroup_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_servicegroup_binding.lbvserver_servicegroup_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.ssl': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.ssl.sslvserver_sslcertkey_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.ssl.sslvserver_sslcertkey_binding.sslvserver_sslcertkey_binding': m,\n        }\n\n        cls.nitro_specific_patcher = patch.dict(sys.modules, nssrc_modules_mock)\n        cls.nitro_base_patcher = nitro_base_patcher\n\n    @classmethod\n    def tearDownClass(cls):\n        cls.nitro_base_patcher.stop()\n        cls.nitro_specific_patcher.stop()\n\n    def setUp(self):\n        super(TestNetscalerLBVServerModule, self).setUp()\n        self.nitro_base_patcher.start()\n        self.nitro_specific_patcher.start()\n\n         Setup minimal required arguments to pass AnsibleModule argument parsing\n\n    def tearDown(self):\n        super(TestNetscalerLBVServerModule, self).tearDown()\n\n        self.nitro_base_patcher.stop()\n        self.nitro_specific_patcher.stop()\n\n    def test_graceful_nitro_api_import_error(self):\n         Stop nitro api patching to cause ImportError\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        self.nitro_base_patcher.stop()\n        self.nitro_specific_patcher.stop()\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n        self.module = netscaler_lb_vserver\n        result = self.failed()\n        self.assertEqual(result['msg'], 'Could not load nitro python sdk')\n\n    def test_graceful_nitro_error_on_login(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        class MockException(Exception):\n            def __init__(self, *args, **kwargs):\n                self.errorcode = 0\n                self.message = ''\n\n        client_mock = Mock()\n        client_mock.login = Mock(side_effect=MockException)\n        m = Mock(return_value=client_mock)\n        with patch('ansible.modules.network.netscaler.netscaler_lb_vserver.get_nitro_client', m):\n            with patch('ansible.modules.network.netscaler.netscaler_lb_vserver.nitro_exception', MockException):\n                self.module = netscaler_lb_vserver\n                result = self.failed()\n                self.assertTrue(result['msg'].startswith('nitro exception'), msg='nitro exception during login not handled properly')\n\n    def test_graceful_no_connection_error(self):\n\n        if sys.version_info[:2] == (2, 6):\n            self.skipTest('requests library not available under python2.6')\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n        attrs = {'login.side_effect': requests.exceptions.ConnectionError}\n        client_mock.configure_mock(**attrs)\n        m = Mock(return_value=client_mock)\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertTrue(result['msg'].startswith('Connection error'), msg='Connection error was not handled gracefully')\n\n    def test_graceful_login_error(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        if sys.version_info[:2] == (2, 6):\n            self.skipTest('requests library not available under python2.6')\n\n        client_mock = Mock()\n        attrs = {'login.side_effect': requests.exceptions.SSLError}\n        client_mock.configure_mock(**attrs)\n        m = Mock(return_value=client_mock)\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            nitro_exception=self.MockException,\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertTrue(result['msg'].startswith('SSL Error'), msg='SSL Error was not handled gracefully')\n\n    def test_save_config_called_on_state_present(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[False, True]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertIn(call.save_config(), client_mock.mock_calls)\n\n    def test_save_config_called_on_state_absent(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[True, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertIn(call.save_config(), client_mock.mock_calls)\n\n    def test_save_config_not_called_on_state_present(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[False, True]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertNotIn(call.save_config(), client_mock.mock_calls)\n\n    def test_save_config_not_called_on_state_absent(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[True, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertNotIn(call.save_config(), client_mock.mock_calls)\n\n    def test_ensure_feature_is_enabled_called(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        lb_vserver_proxy_mock = Mock()\n        feature_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[True, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=feature_mock,\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            feature_mock.assert_called_with(client_mock, 'LB')\n\n    def test_ensure_feature_is_enabled_nitro_exception_caught(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        lb_vserver_proxy_mock = Mock()\n        errorcode = 10\n        message = 'mock error'\n\n        class MockException(Exception):\n            def __init__(self):\n                self.errorcode = errorcode\n                self.message = message\n\n        feature_mock = Mock(side_effect=MockException)\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[True, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=feature_mock,\n            nitro_exception=MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            expected_msg = 'nitro exception errorcode=%s, message=%s' % (errorcode, message)\n            self.assertEqual(result['msg'], expected_msg, 'Failed to handle nitro exception')\n\n    def test_create_new_lb_vserver_workflow(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=Mock()),\n            lb_vserver_exists=Mock(side_effect=[False, True]),\n            lb_vserver_identical=Mock(side_effect=[True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            lb_vserver_proxy_mock.assert_has_calls([call.add()])\n            self.assertTrue(result['changed'])\n\n    def test_update_lb_vserver_workflow(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=Mock()),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=Mock(return_value=[]),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            lb_vserver_proxy_mock.assert_has_calls([call.update()])\n            self.assertTrue(result['changed'])\n\n    def test_service_bindings_handling(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        configured_dict = {\n            'first': Mock(),\n            'second': Mock(has_equal_attributes=Mock(return_value=False)),\n        }\n\n        actual_dict = {\n            'second': Mock(),\n            'third': Mock(),\n        }\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[False, True]),\n            get_configured_service_bindings=Mock(return_value=configured_dict),\n            get_actual_service_bindings=Mock(return_value=actual_dict),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            configured_dict['first'].assert_has_calls([call.add()])\n\n            configured_dict['second'].assert_has_calls([call.has_equal_attributes(actual_dict['second']), call.add()])\n\n            actual_dict['second'].assert_has_calls([call.delete(client_mock, actual_dict['second'])])\n\n            actual_dict['third'].assert_has_calls([call.delete(client_mock, actual_dict['third'])])\n\n            self.assertTrue(result['changed'])\n\n    def test_servicegroup_bindings_handling(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        configured_dict = {\n            'first': Mock(),\n            'second': Mock(has_equal_attributes=Mock(return_value=False)),\n        }\n\n        actual_dict = {\n            'second': Mock(),\n            'third': Mock(),\n        }\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[False, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            get_configured_servicegroup_bindings=Mock(return_value=configured_dict),\n            get_actual_servicegroup_bindings=Mock(return_value=actual_dict),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            configured_dict['first'].assert_has_calls([call.add()])\n\n            configured_dict['second'].assert_has_calls([call.has_equal_attributes(actual_dict['second']), call.add()])\n\n            actual_dict['second'].assert_has_calls([call.delete(client_mock, actual_dict['second'])])\n\n            actual_dict['third'].assert_has_calls([call.delete(client_mock, actual_dict['third'])])\n\n            self.assertTrue(result['changed'])\n\n    def test_ssl_bindings_handling(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n            servicetype='SSL',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            self.assertTrue(len(ssl_sync_mock.mock_calls) > 0, msg='ssl cert_key bindings not called')\n            self.assertTrue(result['changed'])\n\n    def test_ssl_bindings_not_called_for_non_ssl_service(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n            servicetype='HTTP',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            ssl_sync_mock.assert_not_called()\n            self.assertTrue(result['changed'])\n\n    def test_server_exists_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[False, False]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'Did not create lb vserver')\n\n    def test_server_identical_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, False]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'lb vserver is not configured correctly')\n\n    def test_service_bindings_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[False, False]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'service bindings are not identical')\n\n    def test_servicegroup_bindings_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[False, False]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'servicegroup bindings are not identical')\n\n    def test_server_servicegroup_bindings_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[False, False]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'servicegroup bindings are not identical')\n\n    def test_absent_state_workflow(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            lb_vserver_exists=Mock(side_effect=[True, False]),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            lb_vserver_proxy_mock.assert_has_calls([call.delete()])\n            self.assertTrue(result['changed'])\n\n    def test_absent_state_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            lb_vserver_proxy_mock.assert_has_calls([call.delete()])\n            self.assertEqual(result['msg'], 'lb vserver still exists')\n\n    def test_disabled_state_change_called(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        do_state_change_mock = Mock(return_value=Mock(errorcode=0))\n        client_mock = Mock()\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            nitro_exception=self.MockException,\n            do_state_change=do_state_change_mock,\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertTrue(len(do_state_change_mock.mock_calls) > 0, msg='Did not call state change')\n\n    def test_get_immutables_failure(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n        m = Mock(return_value=['some'])\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False]),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=m,\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertTrue(\n                result['msg'].startswith('Cannot update immutable attributes'),\n                msg='Did not handle immutables error correctly',\n            )\n", "comments": "   copyright (c) 2017 citrix systems       this file part ansible       ansible free software  redistribute modify    terms gnu general public license published    free software foundation  either version 3 license     (at option) later version        ansible distributed hope useful     without any warranty  without even implied warranty    merchantability fitness for a particular purpose   see    gnu general public license details        you received copy gnu general public license    along ansible   if  see  http   www gnu org licenses          setup minimal required arguments pass ansiblemodule argument parsing    stop nitro api patching cause importerror ", "content": "\n#  Copyright (c) 2017 Citrix Systems\n#\n# This file is part of Ansible\n#\n# Ansible is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 3 of the License, or\n# (at your option) any later version.\n#\n# Ansible is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.\n#\n\nfrom ansible.compat.tests.mock import patch, Mock, MagicMock, call\nfrom units.modules.utils import set_module_args\nfrom .netscaler_module import TestModule, nitro_base_patcher\n\nimport sys\n\nif sys.version_info[:2] != (2, 6):\n    import requests\n\n\nclass TestNetscalerLBVServerModule(TestModule):\n\n    @classmethod\n    def setUpClass(cls):\n        class MockException(Exception):\n            pass\n\n        cls.MockException = MockException\n\n        m = MagicMock()\n        cls.server_mock = MagicMock()\n        cls.server_mock.__class__ = MagicMock(add=Mock())\n        nssrc_modules_mock = {\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver.lbvserver': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_service_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_service_binding.lbvserver_service_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_servicegroup_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.lb.lbvserver_servicegroup_binding.lbvserver_servicegroup_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.ssl': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.ssl.sslvserver_sslcertkey_binding': m,\n            'nssrc.com.citrix.netscaler.nitro.resource.config.ssl.sslvserver_sslcertkey_binding.sslvserver_sslcertkey_binding': m,\n        }\n\n        cls.nitro_specific_patcher = patch.dict(sys.modules, nssrc_modules_mock)\n        cls.nitro_base_patcher = nitro_base_patcher\n\n    @classmethod\n    def tearDownClass(cls):\n        cls.nitro_base_patcher.stop()\n        cls.nitro_specific_patcher.stop()\n\n    def setUp(self):\n        super(TestNetscalerLBVServerModule, self).setUp()\n        self.nitro_base_patcher.start()\n        self.nitro_specific_patcher.start()\n\n        # Setup minimal required arguments to pass AnsibleModule argument parsing\n\n    def tearDown(self):\n        super(TestNetscalerLBVServerModule, self).tearDown()\n\n        self.nitro_base_patcher.stop()\n        self.nitro_specific_patcher.stop()\n\n    def test_graceful_nitro_api_import_error(self):\n        # Stop nitro api patching to cause ImportError\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        self.nitro_base_patcher.stop()\n        self.nitro_specific_patcher.stop()\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n        self.module = netscaler_lb_vserver\n        result = self.failed()\n        self.assertEqual(result['msg'], 'Could not load nitro python sdk')\n\n    def test_graceful_nitro_error_on_login(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        class MockException(Exception):\n            def __init__(self, *args, **kwargs):\n                self.errorcode = 0\n                self.message = ''\n\n        client_mock = Mock()\n        client_mock.login = Mock(side_effect=MockException)\n        m = Mock(return_value=client_mock)\n        with patch('ansible.modules.network.netscaler.netscaler_lb_vserver.get_nitro_client', m):\n            with patch('ansible.modules.network.netscaler.netscaler_lb_vserver.nitro_exception', MockException):\n                self.module = netscaler_lb_vserver\n                result = self.failed()\n                self.assertTrue(result['msg'].startswith('nitro exception'), msg='nitro exception during login not handled properly')\n\n    def test_graceful_no_connection_error(self):\n\n        if sys.version_info[:2] == (2, 6):\n            self.skipTest('requests library not available under python2.6')\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n        attrs = {'login.side_effect': requests.exceptions.ConnectionError}\n        client_mock.configure_mock(**attrs)\n        m = Mock(return_value=client_mock)\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertTrue(result['msg'].startswith('Connection error'), msg='Connection error was not handled gracefully')\n\n    def test_graceful_login_error(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        if sys.version_info[:2] == (2, 6):\n            self.skipTest('requests library not available under python2.6')\n\n        client_mock = Mock()\n        attrs = {'login.side_effect': requests.exceptions.SSLError}\n        client_mock.configure_mock(**attrs)\n        m = Mock(return_value=client_mock)\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            nitro_exception=self.MockException,\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertTrue(result['msg'].startswith('SSL Error'), msg='SSL Error was not handled gracefully')\n\n    def test_save_config_called_on_state_present(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[False, True]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertIn(call.save_config(), client_mock.mock_calls)\n\n    def test_save_config_called_on_state_absent(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[True, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertIn(call.save_config(), client_mock.mock_calls)\n\n    def test_save_config_not_called_on_state_present(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[False, True]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertNotIn(call.save_config(), client_mock.mock_calls)\n\n    def test_save_config_not_called_on_state_absent(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        m = Mock(return_value=client_mock)\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=m,\n            lb_vserver_exists=Mock(side_effect=[True, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertNotIn(call.save_config(), client_mock.mock_calls)\n\n    def test_ensure_feature_is_enabled_called(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        lb_vserver_proxy_mock = Mock()\n        feature_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[True, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=feature_mock,\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            feature_mock.assert_called_with(client_mock, 'LB')\n\n    def test_ensure_feature_is_enabled_nitro_exception_caught(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        client_mock = Mock()\n\n        lb_vserver_proxy_mock = Mock()\n        errorcode = 10\n        message = 'mock error'\n\n        class MockException(Exception):\n            def __init__(self):\n                self.errorcode = errorcode\n                self.message = message\n\n        feature_mock = Mock(side_effect=MockException)\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[True, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=feature_mock,\n            nitro_exception=MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            expected_msg = 'nitro exception errorcode=%s, message=%s' % (errorcode, message)\n            self.assertEqual(result['msg'], expected_msg, 'Failed to handle nitro exception')\n\n    def test_create_new_lb_vserver_workflow(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=Mock()),\n            lb_vserver_exists=Mock(side_effect=[False, True]),\n            lb_vserver_identical=Mock(side_effect=[True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            lb_vserver_proxy_mock.assert_has_calls([call.add()])\n            self.assertTrue(result['changed'])\n\n    def test_update_lb_vserver_workflow(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=Mock()),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=Mock(return_value=[]),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            lb_vserver_proxy_mock.assert_has_calls([call.update()])\n            self.assertTrue(result['changed'])\n\n    def test_service_bindings_handling(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        configured_dict = {\n            'first': Mock(),\n            'second': Mock(has_equal_attributes=Mock(return_value=False)),\n        }\n\n        actual_dict = {\n            'second': Mock(),\n            'third': Mock(),\n        }\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[False, True]),\n            get_configured_service_bindings=Mock(return_value=configured_dict),\n            get_actual_service_bindings=Mock(return_value=actual_dict),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            configured_dict['first'].assert_has_calls([call.add()])\n\n            configured_dict['second'].assert_has_calls([call.has_equal_attributes(actual_dict['second']), call.add()])\n\n            actual_dict['second'].assert_has_calls([call.delete(client_mock, actual_dict['second'])])\n\n            actual_dict['third'].assert_has_calls([call.delete(client_mock, actual_dict['third'])])\n\n            self.assertTrue(result['changed'])\n\n    def test_servicegroup_bindings_handling(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        configured_dict = {\n            'first': Mock(),\n            'second': Mock(has_equal_attributes=Mock(return_value=False)),\n        }\n\n        actual_dict = {\n            'second': Mock(),\n            'third': Mock(),\n        }\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[False, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            get_configured_servicegroup_bindings=Mock(return_value=configured_dict),\n            get_actual_servicegroup_bindings=Mock(return_value=actual_dict),\n\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            configured_dict['first'].assert_has_calls([call.add()])\n\n            configured_dict['second'].assert_has_calls([call.has_equal_attributes(actual_dict['second']), call.add()])\n\n            actual_dict['second'].assert_has_calls([call.delete(client_mock, actual_dict['second'])])\n\n            actual_dict['third'].assert_has_calls([call.delete(client_mock, actual_dict['third'])])\n\n            self.assertTrue(result['changed'])\n\n    def test_ssl_bindings_handling(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n            servicetype='SSL',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            self.assertTrue(len(ssl_sync_mock.mock_calls) > 0, msg='ssl cert_key bindings not called')\n            self.assertTrue(result['changed'])\n\n    def test_ssl_bindings_not_called_for_non_ssl_service(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n            save_config=False,\n            servicetype='HTTP',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            ssl_sync_mock.assert_not_called()\n            self.assertTrue(result['changed'])\n\n    def test_server_exists_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[False, False]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'Did not create lb vserver')\n\n    def test_server_identical_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n        ssl_sync_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, False]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, True]),\n            ssl_certkey_bindings_sync=ssl_sync_mock,\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'lb vserver is not configured correctly')\n\n    def test_service_bindings_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[True, True]),\n            service_bindings_identical=Mock(side_effect=[False, False]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'service bindings are not identical')\n\n    def test_servicegroup_bindings_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[False, False]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'servicegroup bindings are not identical')\n\n    def test_server_servicegroup_bindings_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False, True]),\n            servicegroup_bindings_identical=Mock(side_effect=[False, False]),\n            service_bindings_identical=Mock(side_effect=[True, True]),\n            ssl_certkey_bindings_identical=Mock(side_effect=[False, False]),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=(Mock(return_value=[])),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertEqual(result['msg'], 'servicegroup bindings are not identical')\n\n    def test_absent_state_workflow(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            lb_vserver_exists=Mock(side_effect=[True, False]),\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.exited()\n            lb_vserver_proxy_mock.assert_has_calls([call.delete()])\n            self.assertTrue(result['changed'])\n\n    def test_absent_state_sanity_check(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='absent',\n        ))\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            lb_vserver_proxy_mock.assert_has_calls([call.delete()])\n            self.assertEqual(result['msg'], 'lb vserver still exists')\n\n    def test_disabled_state_change_called(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        do_state_change_mock = Mock(return_value=Mock(errorcode=0))\n        client_mock = Mock()\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(return_value=True),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            nitro_exception=self.MockException,\n            do_state_change=do_state_change_mock,\n        ):\n            self.module = netscaler_lb_vserver\n            self.exited()\n            self.assertTrue(len(do_state_change_mock.mock_calls) > 0, msg='Did not call state change')\n\n    def test_get_immutables_failure(self):\n        set_module_args(dict(\n            nitro_user='user',\n            nitro_pass='pass',\n            nsip='1.1.1.1',\n            state='present',\n        ))\n\n        from ansible.modules.network.netscaler import netscaler_lb_vserver\n\n        lb_vserver_proxy_mock = Mock()\n\n        client_mock = Mock()\n        m = Mock(return_value=['some'])\n        with patch.multiple(\n            'ansible.modules.network.netscaler.netscaler_lb_vserver',\n            get_nitro_client=Mock(return_value=client_mock),\n            ConfigProxy=Mock(return_value=lb_vserver_proxy_mock),\n            ensure_feature_is_enabled=Mock(),\n            lb_vserver_exists=Mock(side_effect=[True, True]),\n            lb_vserver_identical=Mock(side_effect=[False]),\n            do_state_change=Mock(return_value=Mock(errorcode=0)),\n            get_immutables_intersection=m,\n            nitro_exception=self.MockException,\n        ):\n            self.module = netscaler_lb_vserver\n            result = self.failed()\n            self.assertTrue(\n                result['msg'].startswith('Cannot update immutable attributes'),\n                msg='Did not handle immutables error correctly',\n            )\n", "description": "Ansible is a radically simple IT automation platform that makes your applications and systems easier to deploy. Avoid writing scripts or custom code to deploy and update your applications\u2014 automate in a language that approaches plain English, using SSH, with no agents to install on remote systems.", "file_name": "test_netscaler_lb_vserver.py", "id": "954a6c02a4dff779c0e7c645526c60ea", "language": "Python", "project_name": "ansible", "quality": "", "save_path": "/home/ubuntu/test_files/clean/python/ansible-ansible/ansible-ansible-d30554b/test/units/modules/network/netscaler/test_netscaler_lb_vserver.py", "save_time": "", "source": "", "update_at": "2018-03-18T14:08:28Z", "url": "https://github.com/ansible/ansible", "wiki": false}