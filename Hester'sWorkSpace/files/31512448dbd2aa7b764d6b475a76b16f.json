{"author": "getredash", "code": "import os\nfrom redash.models import db, Organization, Group\nfrom redash import settings\nfrom playhouse.migrate import PostgresqlMigrator, migrate\n\n\nGOOGLE_APPS_DOMAIN = settings.set_from_string(os.environ.get(\"REDASH_GOOGLE_APPS_DOMAIN\", \"\"))\n\nif __name__ == '__main__':\n    migrator = PostgresqlMigrator(db.database)\n\n    with db.database.transaction():\n        Organization.create_table()\n\n        default_org = Organization.create(name=\"Default\", slug='default', settings={\n            Organization.SETTING_GOOGLE_APPS_DOMAINS: list(GOOGLE_APPS_DOMAIN)\n        })\n\n        column = Group.org\n        column.default = default_org\n\n        migrate(\n            migrator.add_column('groups', 'org_id', column),\n            migrator.add_column('events', 'org_id', column),\n            migrator.add_column('data_sources', 'org_id', column),\n            migrator.add_column('users', 'org_id', column),\n            migrator.add_column('dashboards', 'org_id', column),\n            migrator.add_column('queries', 'org_id', column),\n            migrator.add_column('query_results', 'org_id', column),\n        )\n\n        # Change the uniqueness constraint on user email to be (org, email):\n        migrate(\n            migrator.drop_index('users', 'users_email'),\n            migrator.add_index('users', ('org_id', 'email'), unique=True)\n        )\n\n    db.close_db(None)\n", "comments": "  the following deprecated defined organization object    change uniqueness constraint user email (org  email)  ", "content": "import os\nfrom redash.models import db, Organization, Group\nfrom redash import settings\nfrom playhouse.migrate import PostgresqlMigrator, migrate\n\n# The following is deprecated and should be defined with the Organization object\nGOOGLE_APPS_DOMAIN = settings.set_from_string(os.environ.get(\"REDASH_GOOGLE_APPS_DOMAIN\", \"\"))\n\nif __name__ == '__main__':\n    migrator = PostgresqlMigrator(db.database)\n\n    with db.database.transaction():\n        Organization.create_table()\n\n        default_org = Organization.create(name=\"Default\", slug='default', settings={\n            Organization.SETTING_GOOGLE_APPS_DOMAINS: list(GOOGLE_APPS_DOMAIN)\n        })\n\n        column = Group.org\n        column.default = default_org\n\n        migrate(\n            migrator.add_column('groups', 'org_id', column),\n            migrator.add_column('events', 'org_id', column),\n            migrator.add_column('data_sources', 'org_id', column),\n            migrator.add_column('users', 'org_id', column),\n            migrator.add_column('dashboards', 'org_id', column),\n            migrator.add_column('queries', 'org_id', column),\n            migrator.add_column('query_results', 'org_id', column),\n        )\n\n        # Change the uniqueness constraint on user email to be (org, email):\n        migrate(\n            migrator.drop_index('users', 'users_email'),\n            migrator.add_index('users', ('org_id', 'email'), unique=True)\n        )\n\n    db.close_db(None)\n", "description": "Make Your Company Data Driven. Connect to any data source, easily visualize and share your data.", "file_name": "0017_add_organization.py", "id": "31512448dbd2aa7b764d6b475a76b16f", "language": "Python", "project_name": "redash", "quality": "", "save_path": "/home/ubuntu/test_files/clean/python/getredash-redash/getredash-redash-0410d83/old_migrations/0017_add_organization.py", "save_time": "", "source": "", "update_at": "2018-03-18T12:54:55Z", "url": "https://github.com/getredash/redash", "wiki": false}