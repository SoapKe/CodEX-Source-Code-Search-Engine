{"author": "rg3", "code": "\nfrom __future__ import unicode_literals\n\nimport re\n\nfrom .common import InfoExtractor\nfrom ..compat import (\n    compat_HTTPError,\n    compat_str,\n    compat_urlparse,\n)\nfrom ..utils import (\n    determine_ext,\n    ExtractorError,\n    int_or_none,\n    parse_iso8601,\n    qualities,\n    smuggle_url,\n    try_get,\n    unsmuggle_url,\n    update_url_query,\n)\n\n\nclass TVPlayIE(InfoExtractor):\n    IE_NAME = 'mtg'\n    IE_DESC = 'MTG services'\n    _VALID_URL = r\n    _TESTS = [{\n        'url': 'http://www.viafree.se/program/livsstil/husraddarna/sasong-2/avsnitt-2',\n        'info_dict': {\n            'id': '395375',\n            'ext': 'mp4',\n            'title': 'Husr\u00e4ddarna S02E02',\n            'description': 'md5:4db5c933e37db629b5a2f75dfb34829e',\n            'series': 'Husr\u00e4ddarna',\n            'season': 'S\u00e4song 2',\n            'season_number': 2,\n            'duration': 2576,\n            'timestamp': 1400596321,\n            'upload_date': '20140520',\n        },\n        'params': {\n            'skip_download': True,\n        },\n        'add_ie': [TVPlayIE.ie_key()],\n    }, {\n        \n        'url': 'http://www.viafree.se/program/reality/sommaren-med-youtube-stjarnorna/sasong-1/avsnitt-1',\n        'info_dict': {\n            'id': '758770',\n            'ext': 'mp4',\n            'title': 'Sommaren med YouTube-stj\u00e4rnorna S01E01',\n            'description': 'md5:2bc69dce2c4bb48391e858539bbb0e3f',\n            'series': 'Sommaren med YouTube-stj\u00e4rnorna',\n            'season': 'S\u00e4song 1',\n            'season_number': 1,\n            'duration': 1326,\n            'timestamp': 1470905572,\n            'upload_date': '20160811',\n        },\n        'params': {\n            'skip_download': True,\n        },\n        'add_ie': [TVPlayIE.ie_key()],\n    }, {\n        \n        'url': 'http://www.viafree.se/program/reality/sommaren-med-youtube-stjarnorna/sasong-1/avsnitt-2',\n        'only_matching': True,\n    }, {\n        'url': 'http://www.viafree.no/programmer/underholdning/det-beste-vorspielet/sesong-2/episode-1',\n        'only_matching': True,\n    }, {\n        'url': 'http://www.viafree.dk/programmer/reality/paradise-hotel/saeson-7/episode-5',\n        'only_matching': True,\n    }]\n\n    @classmethod\n    def suitable(cls, url):\n        return False if TVPlayIE.suitable(url) else super(ViafreeIE, cls).suitable(url)\n\n    def _real_extract(self, url):\n        video_id = self._match_id(url)\n\n        webpage = self._download_webpage(url, video_id)\n\n        data = self._parse_json(\n            self._search_regex(\n                r'(?s)window\\.App\\s*=\\s*({.+?})\\s*;\\s*</script',\n                webpage, 'data', default='{}'),\n            video_id, transform_source=lambda x: re.sub(\n                r'(?s)function\\s+[a-zA-Z_][\\da-zA-Z_]*\\s*\\([^)]*\\)\\s*{[^}]*}\\s*',\n                'null', x), fatal=False)\n\n        video_id = None\n\n        if data:\n            video_id = try_get(\n                data, lambda x: x['context']['dispatcher']['stores'][\n                    'ContentPageProgramStore']['currentVideo']['id'],\n                compat_str)\n\n        \n        if not video_id:\n            thumbnail = self._og_search_thumbnail(webpage, default=None)\n            if thumbnail:\n                video_id = self._search_regex(\n                    \n                    \n                    \n                    r'https?://[^/]+/imagecache/(?:[^/]+/)+(\\d{6,})/',\n                    thumbnail, 'video id', default=None)\n\n        \n        \n        if not video_id:\n            video_id = self._search_regex(\n                r'currentVideo[\"\\']\\s*:\\s*.+?[\"\\']id[\"\\']\\s*:\\s*[\"\\'](\\d{6,})',\n                webpage, 'video id')\n\n        return self.url_result(\n            smuggle_url(\n                'mtg:%s' % video_id,\n                {\n                    'geo_countries': [\n                        compat_urlparse.urlparse(url).netloc.rsplit('.', 1)[-1]],\n                    \n                    'skip_rtmp': True,\n                }),\n            ie=TVPlayIE.ie_key(), video_id=video_id)\n", "comments": "(?x)\n                    (?:\n                        mtg:|\n                        https?://\n                            (?:www\\.)?\n                            (?:\n                                tvplay(?:\\.skaties)?\\.lv/parraides|\n                                (?:tv3play|play\\.tv3)\\.lt/programos|\n                                tv3play(?:\\.tv3)?\\.ee/sisu|\n                                (?:tv(?:3|6|8|10)play|viafree)\\.se/program|\n                                (?:(?:tv3play|viasat4play|tv6play|viafree)\\.no|(?:tv3play|viafree)\\.dk)/programmer|\n                                play\\.novatv\\.bg/programi\n                            )\n                            /(?:[^/]+/)+\n                        )\n                        (?P<id>\\d+)\n                    '''\n    _TESTS = [\n        {\n            'url': 'http://www.tvplay.lv/parraides/vinas-melo-labak/418113?autostart=true',\n            'md5': 'a1612fe0849455423ad8718fe049be21',\n            'info_dict': {\n                'id': '418113',\n                'ext': 'mp4',\n                'title': 'K\u0101di ir \u012bri? - Vi\u0146as melo lab\u0101k',\n                'description': 'Baiba apsmej \u012brus, k\u0101di tie ir un ko vi\u0146i dara.',\n                'series': 'Vi\u0146as melo lab\u0101k',\n                'season': '2.sezona',\n                'season_number': 2,\n                'duration': 25,\n                'timestamp': 1406097056,\n                'upload_date': '20140723',\n            },\n        },\n        {\n            'url': 'http://play.tv3.lt/programos/moterys-meluoja-geriau/409229?autostart=true',\n            'info_dict': {\n                'id': '409229',\n                'ext': 'flv',\n                'title': 'Moterys meluoja geriau',\n                'description': 'md5:9aec0fc68e2cbc992d2a140bd41fa89e',\n                'series': 'Moterys meluoja geriau',\n                'episode_number': 47,\n                'season': '1 sezonas',\n                'season_number': 1,\n                'duration': 1330,\n                'timestamp': 1403769181,\n                'upload_date': '20140626',\n            },\n            'params': {\n                # rtmp download\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv3play.ee/sisu/kodu-keset-linna/238551?autostart=true',\n            'info_dict': {\n                'id': '238551',\n                'ext': 'flv',\n                'title': 'Kodu keset linna 398537',\n                'description': 'md5:7df175e3c94db9e47c0d81ffa5d68701',\n                'duration': 1257,\n                'timestamp': 1292449761,\n                'upload_date': '20101215',\n            },\n            'params': {\n                # rtmp download\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv3play.se/program/husraddarna/395385?autostart=true',\n            'info_dict': {\n                'id': '395385',\n                'ext': 'mp4',\n                'title': 'Husr\u00e4ddarna S02E07',\n                'description': 'md5:f210c6c89f42d4fc39faa551be813777',\n                'duration': 2574,\n                'timestamp': 1400596321,\n                'upload_date': '20140520',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv6play.se/program/den-sista-dokusapan/266636?autostart=true',\n            'info_dict': {\n                'id': '266636',\n                'ext': 'mp4',\n                'title': 'Den sista dokus\u00e5pan S01E08',\n                'description': 'md5:295be39c872520221b933830f660b110',\n                'duration': 1492,\n                'timestamp': 1330522854,\n                'upload_date': '20120229',\n                'age_limit': 18,\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv8play.se/program/antikjakten/282756?autostart=true',\n            'info_dict': {\n                'id': '282756',\n                'ext': 'mp4',\n                'title': 'Antikjakten S01E10',\n                'description': 'md5:1b201169beabd97e20c5ad0ad67b13b8',\n                'duration': 2646,\n                'timestamp': 1348575868,\n                'upload_date': '20120925',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv3play.no/programmer/anna-anka-soker-assistent/230898?autostart=true',\n            'info_dict': {\n                'id': '230898',\n                'ext': 'mp4',\n                'title': 'Anna Anka s\u00f8ker assistent - Ep. 8',\n                'description': 'md5:f80916bf5bbe1c5f760d127f8dd71474',\n                'duration': 2656,\n                'timestamp': 1277720005,\n                'upload_date': '20100628',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.viasat4play.no/programmer/budbringerne/21873?autostart=true',\n            'info_dict': {\n                'id': '21873',\n                'ext': 'mp4',\n                'title': 'Budbringerne program 10',\n                'description': 'md5:4db78dc4ec8a85bb04fd322a3ee5092d',\n                'duration': 1297,\n                'timestamp': 1254205102,\n                'upload_date': '20090929',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv6play.no/programmer/hotelinspektor-alex-polizzi/361883?autostart=true',\n            'info_dict': {\n                'id': '361883',\n                'ext': 'mp4',\n                'title': 'Hotelinspekt\u00f8r Alex Polizzi - Ep. 10',\n                'description': 'md5:3ecf808db9ec96c862c8ecb3a7fdaf81',\n                'duration': 2594,\n                'timestamp': 1393236292,\n                'upload_date': '20140224',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://play.novatv.bg/programi/zdravei-bulgariya/624952?autostart=true',\n            'info_dict': {\n                'id': '624952',\n                'ext': 'flv',\n                'title': '\u0417\u0434\u0440\u0430\u0432\u0435\u0439, \u0411\u044a\u043b\u0433\u0430\u0440\u0438\u044f (12.06.2015 \u0433.) ',\n                'description': 'md5:99f3700451ac5bb71a260268b8daefd7',\n                'duration': 8838,\n                'timestamp': 1434100372,\n                'upload_date': '20150612',\n            },\n            'params': {\n                # rtmp download\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://tvplay.skaties.lv/parraides/vinas-melo-labak/418113?autostart=true',\n            'only_matching': True,\n        },\n        {\n            # views is null\n            'url': 'http://tvplay.skaties.lv/parraides/tv3-zinas/760183',\n            'only_matching': True,\n        },\n        {\n            'url': 'http://tv3play.tv3.ee/sisu/kodu-keset-linna/238551?autostart=true',\n            'only_matching': True,\n        },\n        {\n            'url': 'http://www.viafree.se/program/underhallning/i-like-radio-live/sasong-1/676869',\n            'only_matching': True,\n        },\n        {\n            'url': 'mtg:418113',\n            'only_matching': True,\n        }\n    ]\n\n    def _real_extract(self, url):\n        url, smuggled_data = unsmuggle_url(url, {})\n        self._initialize_geo_bypass(smuggled_data.get('geo_countries'))\n\n        video_id = self._match_id(url)\n        geo_country = self._search_regex(\n            r'https?://[^/]+\\.([a-z]{2})', url,\n            'geo country', default=None)\n        if geo_country:\n            self._initialize_geo_bypass([geo_country.upper()])\n        video = self._download_json(\n            'http://playapi.mtgx.tv/v3/videos/%s' % video_id, video_id, 'Downloading video JSON')\n\n        title = video['title']\n\n        try:\n            streams = self._download_json(\n                'http://playapi.mtgx.tv/v3/videos/stream/%s' % video_id,\n                video_id, 'Downloading streams JSON')\n        except ExtractorError as e:\n            if isinstance(e.cause, compat_HTTPError) and e.cause.code == 403:\n                msg = self._parse_json(e.cause.read().decode('utf-8'), video_id)\n                raise ExtractorError(msg['msg'], expected=True)\n            raise\n\n        quality = qualities(['hls', 'medium', 'high'])\n        formats = []\n        for format_id, video_url in streams.get('streams', {}).items():\n            if not video_url or not isinstance(video_url, compat_str):\n                continue\n            ext = determine_ext(video_url)\n            if ext == 'f4m':\n                formats.extend(self._extract_f4m_formats(\n                    update_url_query(video_url, {\n                        'hdcore': '3.5.0',\n                        'plugin': 'aasp-3.5.0.151.81'\n                    }), video_id, f4m_id='hds', fatal=False))\n            elif ext == 'm3u8':\n                formats.extend(self._extract_m3u8_formats(\n                    video_url, video_id, 'mp4', 'm3u8_native',\n                    m3u8_id='hls', fatal=False))\n            else:\n                fmt = {\n                    'format_id': format_id,\n                    'quality': quality(format_id),\n                    'ext': ext,\n                }\n                if video_url.startswith('rtmp'):\n                    if smuggled_data.get('skip_rtmp'):\n                        continue\n                    m = re.search(\n                        r'^(?P<url>rtmp://[^/]+/(?P<app>[^/]+))/(?P<playpath>.+)$', video_url)\n                    if not m:\n                        continue\n                    fmt.update({\n                        'ext': 'flv',\n                        'url': m.group('url'),\n                        'app': m.group('app'),\n                        'play_path': m.group('playpath'),\n                    })\n                else:\n                    fmt.update({\n                        'url': video_url,\n                    })\n                formats.append(fmt)\n\n        if not formats and video.get('is_geo_blocked'):\n            self.raise_geo_restricted(\n                'This content might not be available in your country due to copyright reasons')\n\n        self._sort_formats(formats)\n\n        # TODO: webvtt in m3u8\n        subtitles = {}\n        sami_path = video.get('sami_path')\n        if sami_path:\n            lang = self._search_regex(\n                r'_([a-z]{2})\\.xml', sami_path, 'lang',\n                default=compat_urlparse.urlparse(url).netloc.rsplit('.', 1)[-1])\n            subtitles[lang] = [{\n                'url': sami_path,\n            }]\n\n        series = video.get('format_title')\n        episode_number = int_or_none(video.get('format_position', {}).get('episode'))\n        season = video.get('_embedded', {}).get('season', {}).get('title')\n        season_number = int_or_none(video.get('format_position', {}).get('season'))\n\n        return {\n            'id': video_id,\n            'title': title,\n            'description': video.get('description'),\n            'series': series,\n            'episode_number': episode_number,\n            'season': season,\n            'season_number': season_number,\n            'duration': int_or_none(video.get('duration')),\n            'timestamp': parse_iso8601(video.get('created_at')),\n            'view_count': try_get(video, lambda x: x['views']['total'], int),\n            'age_limit': int_or_none(video.get('age_limit', 0)),\n            'formats': formats,\n            'subtitles': subtitles,\n        }\n\n\nclass ViafreeIE(InfoExtractor):\n    _VALID_URL = r'''(?x)\n                    https?://\n                        (?:www\\.)?\n                        viafree\\.\n                        (?:\n                            (?:dk|no)/programmer|\n                            se/program\n                        )\n                        /(?:[^/]+/)+(?P<id>[^/?#&]+)\n                    \n \n# coding: utf-8\n# with relatedClips\n# Different og:image URL schema\n# Fallback #1 (extract from og:image URL schema)\n# Patterns seen:\n#  http://cdn.playapi.mtgx.tv/imagecache/600x315/cloud/content-images/inbox/765166/a2e95e5f1d735bab9f309fa345cc3f25.jpg\n#  http://cdn.playapi.mtgx.tv/imagecache/600x315/cloud/content-images/seasons/15204/758770/4a5ba509ca8bc043e1ebd1a76131cdf2.jpg\n# Fallback #2. Extract from raw JSON string.\n# May extract wrong video id if relatedClips is present.\n# rtmp host mtgfs.fplive.net for viafree is unresolvable\n", "content": "# coding: utf-8\nfrom __future__ import unicode_literals\n\nimport re\n\nfrom .common import InfoExtractor\nfrom ..compat import (\n    compat_HTTPError,\n    compat_str,\n    compat_urlparse,\n)\nfrom ..utils import (\n    determine_ext,\n    ExtractorError,\n    int_or_none,\n    parse_iso8601,\n    qualities,\n    smuggle_url,\n    try_get,\n    unsmuggle_url,\n    update_url_query,\n)\n\n\nclass TVPlayIE(InfoExtractor):\n    IE_NAME = 'mtg'\n    IE_DESC = 'MTG services'\n    _VALID_URL = r'''(?x)\n                    (?:\n                        mtg:|\n                        https?://\n                            (?:www\\.)?\n                            (?:\n                                tvplay(?:\\.skaties)?\\.lv/parraides|\n                                (?:tv3play|play\\.tv3)\\.lt/programos|\n                                tv3play(?:\\.tv3)?\\.ee/sisu|\n                                (?:tv(?:3|6|8|10)play|viafree)\\.se/program|\n                                (?:(?:tv3play|viasat4play|tv6play|viafree)\\.no|(?:tv3play|viafree)\\.dk)/programmer|\n                                play\\.novatv\\.bg/programi\n                            )\n                            /(?:[^/]+/)+\n                        )\n                        (?P<id>\\d+)\n                    '''\n    _TESTS = [\n        {\n            'url': 'http://www.tvplay.lv/parraides/vinas-melo-labak/418113?autostart=true',\n            'md5': 'a1612fe0849455423ad8718fe049be21',\n            'info_dict': {\n                'id': '418113',\n                'ext': 'mp4',\n                'title': 'K\u0101di ir \u012bri? - Vi\u0146as melo lab\u0101k',\n                'description': 'Baiba apsmej \u012brus, k\u0101di tie ir un ko vi\u0146i dara.',\n                'series': 'Vi\u0146as melo lab\u0101k',\n                'season': '2.sezona',\n                'season_number': 2,\n                'duration': 25,\n                'timestamp': 1406097056,\n                'upload_date': '20140723',\n            },\n        },\n        {\n            'url': 'http://play.tv3.lt/programos/moterys-meluoja-geriau/409229?autostart=true',\n            'info_dict': {\n                'id': '409229',\n                'ext': 'flv',\n                'title': 'Moterys meluoja geriau',\n                'description': 'md5:9aec0fc68e2cbc992d2a140bd41fa89e',\n                'series': 'Moterys meluoja geriau',\n                'episode_number': 47,\n                'season': '1 sezonas',\n                'season_number': 1,\n                'duration': 1330,\n                'timestamp': 1403769181,\n                'upload_date': '20140626',\n            },\n            'params': {\n                # rtmp download\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv3play.ee/sisu/kodu-keset-linna/238551?autostart=true',\n            'info_dict': {\n                'id': '238551',\n                'ext': 'flv',\n                'title': 'Kodu keset linna 398537',\n                'description': 'md5:7df175e3c94db9e47c0d81ffa5d68701',\n                'duration': 1257,\n                'timestamp': 1292449761,\n                'upload_date': '20101215',\n            },\n            'params': {\n                # rtmp download\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv3play.se/program/husraddarna/395385?autostart=true',\n            'info_dict': {\n                'id': '395385',\n                'ext': 'mp4',\n                'title': 'Husr\u00e4ddarna S02E07',\n                'description': 'md5:f210c6c89f42d4fc39faa551be813777',\n                'duration': 2574,\n                'timestamp': 1400596321,\n                'upload_date': '20140520',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv6play.se/program/den-sista-dokusapan/266636?autostart=true',\n            'info_dict': {\n                'id': '266636',\n                'ext': 'mp4',\n                'title': 'Den sista dokus\u00e5pan S01E08',\n                'description': 'md5:295be39c872520221b933830f660b110',\n                'duration': 1492,\n                'timestamp': 1330522854,\n                'upload_date': '20120229',\n                'age_limit': 18,\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv8play.se/program/antikjakten/282756?autostart=true',\n            'info_dict': {\n                'id': '282756',\n                'ext': 'mp4',\n                'title': 'Antikjakten S01E10',\n                'description': 'md5:1b201169beabd97e20c5ad0ad67b13b8',\n                'duration': 2646,\n                'timestamp': 1348575868,\n                'upload_date': '20120925',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv3play.no/programmer/anna-anka-soker-assistent/230898?autostart=true',\n            'info_dict': {\n                'id': '230898',\n                'ext': 'mp4',\n                'title': 'Anna Anka s\u00f8ker assistent - Ep. 8',\n                'description': 'md5:f80916bf5bbe1c5f760d127f8dd71474',\n                'duration': 2656,\n                'timestamp': 1277720005,\n                'upload_date': '20100628',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.viasat4play.no/programmer/budbringerne/21873?autostart=true',\n            'info_dict': {\n                'id': '21873',\n                'ext': 'mp4',\n                'title': 'Budbringerne program 10',\n                'description': 'md5:4db78dc4ec8a85bb04fd322a3ee5092d',\n                'duration': 1297,\n                'timestamp': 1254205102,\n                'upload_date': '20090929',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://www.tv6play.no/programmer/hotelinspektor-alex-polizzi/361883?autostart=true',\n            'info_dict': {\n                'id': '361883',\n                'ext': 'mp4',\n                'title': 'Hotelinspekt\u00f8r Alex Polizzi - Ep. 10',\n                'description': 'md5:3ecf808db9ec96c862c8ecb3a7fdaf81',\n                'duration': 2594,\n                'timestamp': 1393236292,\n                'upload_date': '20140224',\n            },\n            'params': {\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://play.novatv.bg/programi/zdravei-bulgariya/624952?autostart=true',\n            'info_dict': {\n                'id': '624952',\n                'ext': 'flv',\n                'title': '\u0417\u0434\u0440\u0430\u0432\u0435\u0439, \u0411\u044a\u043b\u0433\u0430\u0440\u0438\u044f (12.06.2015 \u0433.) ',\n                'description': 'md5:99f3700451ac5bb71a260268b8daefd7',\n                'duration': 8838,\n                'timestamp': 1434100372,\n                'upload_date': '20150612',\n            },\n            'params': {\n                # rtmp download\n                'skip_download': True,\n            },\n        },\n        {\n            'url': 'http://tvplay.skaties.lv/parraides/vinas-melo-labak/418113?autostart=true',\n            'only_matching': True,\n        },\n        {\n            # views is null\n            'url': 'http://tvplay.skaties.lv/parraides/tv3-zinas/760183',\n            'only_matching': True,\n        },\n        {\n            'url': 'http://tv3play.tv3.ee/sisu/kodu-keset-linna/238551?autostart=true',\n            'only_matching': True,\n        },\n        {\n            'url': 'http://www.viafree.se/program/underhallning/i-like-radio-live/sasong-1/676869',\n            'only_matching': True,\n        },\n        {\n            'url': 'mtg:418113',\n            'only_matching': True,\n        }\n    ]\n\n    def _real_extract(self, url):\n        url, smuggled_data = unsmuggle_url(url, {})\n        self._initialize_geo_bypass(smuggled_data.get('geo_countries'))\n\n        video_id = self._match_id(url)\n        geo_country = self._search_regex(\n            r'https?://[^/]+\\.([a-z]{2})', url,\n            'geo country', default=None)\n        if geo_country:\n            self._initialize_geo_bypass([geo_country.upper()])\n        video = self._download_json(\n            'http://playapi.mtgx.tv/v3/videos/%s' % video_id, video_id, 'Downloading video JSON')\n\n        title = video['title']\n\n        try:\n            streams = self._download_json(\n                'http://playapi.mtgx.tv/v3/videos/stream/%s' % video_id,\n                video_id, 'Downloading streams JSON')\n        except ExtractorError as e:\n            if isinstance(e.cause, compat_HTTPError) and e.cause.code == 403:\n                msg = self._parse_json(e.cause.read().decode('utf-8'), video_id)\n                raise ExtractorError(msg['msg'], expected=True)\n            raise\n\n        quality = qualities(['hls', 'medium', 'high'])\n        formats = []\n        for format_id, video_url in streams.get('streams', {}).items():\n            if not video_url or not isinstance(video_url, compat_str):\n                continue\n            ext = determine_ext(video_url)\n            if ext == 'f4m':\n                formats.extend(self._extract_f4m_formats(\n                    update_url_query(video_url, {\n                        'hdcore': '3.5.0',\n                        'plugin': 'aasp-3.5.0.151.81'\n                    }), video_id, f4m_id='hds', fatal=False))\n            elif ext == 'm3u8':\n                formats.extend(self._extract_m3u8_formats(\n                    video_url, video_id, 'mp4', 'm3u8_native',\n                    m3u8_id='hls', fatal=False))\n            else:\n                fmt = {\n                    'format_id': format_id,\n                    'quality': quality(format_id),\n                    'ext': ext,\n                }\n                if video_url.startswith('rtmp'):\n                    if smuggled_data.get('skip_rtmp'):\n                        continue\n                    m = re.search(\n                        r'^(?P<url>rtmp://[^/]+/(?P<app>[^/]+))/(?P<playpath>.+)$', video_url)\n                    if not m:\n                        continue\n                    fmt.update({\n                        'ext': 'flv',\n                        'url': m.group('url'),\n                        'app': m.group('app'),\n                        'play_path': m.group('playpath'),\n                    })\n                else:\n                    fmt.update({\n                        'url': video_url,\n                    })\n                formats.append(fmt)\n\n        if not formats and video.get('is_geo_blocked'):\n            self.raise_geo_restricted(\n                'This content might not be available in your country due to copyright reasons')\n\n        self._sort_formats(formats)\n\n        # TODO: webvtt in m3u8\n        subtitles = {}\n        sami_path = video.get('sami_path')\n        if sami_path:\n            lang = self._search_regex(\n                r'_([a-z]{2})\\.xml', sami_path, 'lang',\n                default=compat_urlparse.urlparse(url).netloc.rsplit('.', 1)[-1])\n            subtitles[lang] = [{\n                'url': sami_path,\n            }]\n\n        series = video.get('format_title')\n        episode_number = int_or_none(video.get('format_position', {}).get('episode'))\n        season = video.get('_embedded', {}).get('season', {}).get('title')\n        season_number = int_or_none(video.get('format_position', {}).get('season'))\n\n        return {\n            'id': video_id,\n            'title': title,\n            'description': video.get('description'),\n            'series': series,\n            'episode_number': episode_number,\n            'season': season,\n            'season_number': season_number,\n            'duration': int_or_none(video.get('duration')),\n            'timestamp': parse_iso8601(video.get('created_at')),\n            'view_count': try_get(video, lambda x: x['views']['total'], int),\n            'age_limit': int_or_none(video.get('age_limit', 0)),\n            'formats': formats,\n            'subtitles': subtitles,\n        }\n\n\nclass ViafreeIE(InfoExtractor):\n    _VALID_URL = r'''(?x)\n                    https?://\n                        (?:www\\.)?\n                        viafree\\.\n                        (?:\n                            (?:dk|no)/programmer|\n                            se/program\n                        )\n                        /(?:[^/]+/)+(?P<id>[^/?#&]+)\n                    '''\n    _TESTS = [{\n        'url': 'http://www.viafree.se/program/livsstil/husraddarna/sasong-2/avsnitt-2',\n        'info_dict': {\n            'id': '395375',\n            'ext': 'mp4',\n            'title': 'Husr\u00e4ddarna S02E02',\n            'description': 'md5:4db5c933e37db629b5a2f75dfb34829e',\n            'series': 'Husr\u00e4ddarna',\n            'season': 'S\u00e4song 2',\n            'season_number': 2,\n            'duration': 2576,\n            'timestamp': 1400596321,\n            'upload_date': '20140520',\n        },\n        'params': {\n            'skip_download': True,\n        },\n        'add_ie': [TVPlayIE.ie_key()],\n    }, {\n        # with relatedClips\n        'url': 'http://www.viafree.se/program/reality/sommaren-med-youtube-stjarnorna/sasong-1/avsnitt-1',\n        'info_dict': {\n            'id': '758770',\n            'ext': 'mp4',\n            'title': 'Sommaren med YouTube-stj\u00e4rnorna S01E01',\n            'description': 'md5:2bc69dce2c4bb48391e858539bbb0e3f',\n            'series': 'Sommaren med YouTube-stj\u00e4rnorna',\n            'season': 'S\u00e4song 1',\n            'season_number': 1,\n            'duration': 1326,\n            'timestamp': 1470905572,\n            'upload_date': '20160811',\n        },\n        'params': {\n            'skip_download': True,\n        },\n        'add_ie': [TVPlayIE.ie_key()],\n    }, {\n        # Different og:image URL schema\n        'url': 'http://www.viafree.se/program/reality/sommaren-med-youtube-stjarnorna/sasong-1/avsnitt-2',\n        'only_matching': True,\n    }, {\n        'url': 'http://www.viafree.no/programmer/underholdning/det-beste-vorspielet/sesong-2/episode-1',\n        'only_matching': True,\n    }, {\n        'url': 'http://www.viafree.dk/programmer/reality/paradise-hotel/saeson-7/episode-5',\n        'only_matching': True,\n    }]\n\n    @classmethod\n    def suitable(cls, url):\n        return False if TVPlayIE.suitable(url) else super(ViafreeIE, cls).suitable(url)\n\n    def _real_extract(self, url):\n        video_id = self._match_id(url)\n\n        webpage = self._download_webpage(url, video_id)\n\n        data = self._parse_json(\n            self._search_regex(\n                r'(?s)window\\.App\\s*=\\s*({.+?})\\s*;\\s*</script',\n                webpage, 'data', default='{}'),\n            video_id, transform_source=lambda x: re.sub(\n                r'(?s)function\\s+[a-zA-Z_][\\da-zA-Z_]*\\s*\\([^)]*\\)\\s*{[^}]*}\\s*',\n                'null', x), fatal=False)\n\n        video_id = None\n\n        if data:\n            video_id = try_get(\n                data, lambda x: x['context']['dispatcher']['stores'][\n                    'ContentPageProgramStore']['currentVideo']['id'],\n                compat_str)\n\n        # Fallback #1 (extract from og:image URL schema)\n        if not video_id:\n            thumbnail = self._og_search_thumbnail(webpage, default=None)\n            if thumbnail:\n                video_id = self._search_regex(\n                    # Patterns seen:\n                    #  http://cdn.playapi.mtgx.tv/imagecache/600x315/cloud/content-images/inbox/765166/a2e95e5f1d735bab9f309fa345cc3f25.jpg\n                    #  http://cdn.playapi.mtgx.tv/imagecache/600x315/cloud/content-images/seasons/15204/758770/4a5ba509ca8bc043e1ebd1a76131cdf2.jpg\n                    r'https?://[^/]+/imagecache/(?:[^/]+/)+(\\d{6,})/',\n                    thumbnail, 'video id', default=None)\n\n        # Fallback #2. Extract from raw JSON string.\n        # May extract wrong video id if relatedClips is present.\n        if not video_id:\n            video_id = self._search_regex(\n                r'currentVideo[\"\\']\\s*:\\s*.+?[\"\\']id[\"\\']\\s*:\\s*[\"\\'](\\d{6,})',\n                webpage, 'video id')\n\n        return self.url_result(\n            smuggle_url(\n                'mtg:%s' % video_id,\n                {\n                    'geo_countries': [\n                        compat_urlparse.urlparse(url).netloc.rsplit('.', 1)[-1]],\n                    # rtmp host mtgfs.fplive.net for viafree is unresolvable\n                    'skip_rtmp': True,\n                }),\n            ie=TVPlayIE.ie_key(), video_id=video_id)\n", "description": "Command-line program to download videos from YouTube.com and other video sites", "file_name": "tvplay.py", "language": "Python", "project_name": "youtube-dl", "quality": "", "save_path": "/home/ubuntu/test_files/clean/python/rg3_youtube-dl/rg3-youtube-dl-6202f08/youtube_dl/extractor/tvplay.py", "save_time": "", "source": "", "update_at": "2018-03-07T09:18:39Z", "url": "https://github.com/rg3/youtube-dl", "wiki": false}