{"author": "odoo", "code": "# -*- coding: utf-8 -*-\n\nimport base64\n\nimport werkzeug\n\nfrom odoo import _, exceptions, http\nfrom odoo.http import request\nfrom odoo.tools import consteq\n\n\nclass MassMailController(http.Controller):\n\n    @http.route(['/mail/mailing/<int:mailing_id>/unsubscribe'], type='http', website=True, auth='public')\n    def mailing(self, mailing_id, email=None, res_id=None, token=\"\", **post):\n        mailing = request.env['mail.mass_mailing'].sudo().browse(mailing_id)\n        if mailing.exists():\n            res_id = res_id and int(res_id)\n            res_ids = []\n            if mailing.mailing_model_name == 'mail.mass_mailing.list':\n                contacts = request.env['mail.mass_mailing.contact'].sudo().search([\n                    ('email', '=', email),\n                    ('list_ids', 'in', [mailing_list.id for mailing_list in mailing.contact_list_ids])\n                ])\n                res_ids = contacts.ids\n            else:\n                res_ids = [res_id]\n\n            right_token = mailing._unsubscribe_token(res_id, email)\n            if not consteq(str(token), right_token):\n                raise exceptions.AccessDenied()\n            mailing.update_opt_out(email, res_ids, True)\n            return _('You have been unsubscribed successfully')\n\n    @http.route('/mail/track/<int:mail_id>/blank.gif', type='http', auth='none')\n    def track_mail_open(self, mail_id, **post):\n        \n        request.env['mail.mail.statistics'].sudo().set_opened(mail_mail_ids=[mail_id])\n        response = werkzeug.wrappers.Response()\n        response.mimetype = 'image/gif'\n        response.data = base64.b64decode(b'R0lGODlhAQABAIAAANvf7wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==')\n\n        return response\n\n    @http.route('/r/<string:code>/m/<int:stat_id>', type='http', auth=\"none\")\n    def full_url_redirect(self, code, stat_id, **post):\n        \n        \n        country_code = request.session.get('geoip', False) and request.session.geoip.get('country_code', False)\n\n        request.env['link.tracker.click'].add_click(code, request.httprequest.remote_addr, country_code, stat_id=stat_id)\n        return werkzeug.utils.redirect(request.env['link.tracker'].get_url_from_code(code), 301)\n", "comments": "    email tracking             coding  utf 8        part odoo  see license file full copyright licensing details     assume geoip set  part website module    mass mailing depend ", "content": "# -*- coding: utf-8 -*-\n# Part of Odoo. See LICENSE file for full copyright and licensing details.\nimport base64\n\nimport werkzeug\n\nfrom odoo import _, exceptions, http\nfrom odoo.http import request\nfrom odoo.tools import consteq\n\n\nclass MassMailController(http.Controller):\n\n    @http.route(['/mail/mailing/<int:mailing_id>/unsubscribe'], type='http', website=True, auth='public')\n    def mailing(self, mailing_id, email=None, res_id=None, token=\"\", **post):\n        mailing = request.env['mail.mass_mailing'].sudo().browse(mailing_id)\n        if mailing.exists():\n            res_id = res_id and int(res_id)\n            res_ids = []\n            if mailing.mailing_model_name == 'mail.mass_mailing.list':\n                contacts = request.env['mail.mass_mailing.contact'].sudo().search([\n                    ('email', '=', email),\n                    ('list_ids', 'in', [mailing_list.id for mailing_list in mailing.contact_list_ids])\n                ])\n                res_ids = contacts.ids\n            else:\n                res_ids = [res_id]\n\n            right_token = mailing._unsubscribe_token(res_id, email)\n            if not consteq(str(token), right_token):\n                raise exceptions.AccessDenied()\n            mailing.update_opt_out(email, res_ids, True)\n            return _('You have been unsubscribed successfully')\n\n    @http.route('/mail/track/<int:mail_id>/blank.gif', type='http', auth='none')\n    def track_mail_open(self, mail_id, **post):\n        \"\"\" Email tracking. \"\"\"\n        request.env['mail.mail.statistics'].sudo().set_opened(mail_mail_ids=[mail_id])\n        response = werkzeug.wrappers.Response()\n        response.mimetype = 'image/gif'\n        response.data = base64.b64decode(b'R0lGODlhAQABAIAAANvf7wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==')\n\n        return response\n\n    @http.route('/r/<string:code>/m/<int:stat_id>', type='http', auth=\"none\")\n    def full_url_redirect(self, code, stat_id, **post):\n        # don't assume geoip is set, it is part of the website module\n        # which mass_mailing doesn't depend on\n        country_code = request.session.get('geoip', False) and request.session.geoip.get('country_code', False)\n\n        request.env['link.tracker.click'].add_click(code, request.httprequest.remote_addr, country_code, stat_id=stat_id)\n        return werkzeug.utils.redirect(request.env['link.tracker'].get_url_from_code(code), 301)\n", "description": "Odoo. Open Source Apps To Grow Your Business.", "file_name": "main.py", "id": "56b3f73695f40c34a92a0df918bc9f65", "language": "Python", "project_name": "odoo", "quality": "", "save_path": "/home/ubuntu/test_files/clean/python/odoo-odoo/odoo-odoo-b25250f/addons/mass_mailing/controllers/main.py", "save_time": "", "source": "", "update_at": "2018-03-18T08:30:22Z", "url": "https://github.com/odoo/odoo", "wiki": true}