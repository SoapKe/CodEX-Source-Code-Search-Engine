{"author": "getredash", "code": "from base64 import b64encode\nimport json\nfrom redash.models import DataSource\n\n\ndef convert_p12_to_pem(p12file):\n    from OpenSSL import crypto\n    with open(p12file, 'rb') as f:\n        p12 = crypto.load_pkcs12(f.read(), \"notasecret\")\n\n    return crypto.dump_privatekey(crypto.FILETYPE_PEM, p12.get_privatekey())\n\nif __name__ == '__main__':\n\n    for ds in DataSource.select(DataSource.id, DataSource.type, DataSource.options):\n\n        if ds.type == 'bigquery':\n            options = json.loads(ds.options)\n\n            if 'jsonKeyFile' in options:\n                continue\n\n            new_options = {\n                'projectId': options['projectId'],\n                'jsonKeyFile': b64encode(json.dumps({\n                    'client_email': options['serviceAccount'],\n                    'private_key': convert_p12_to_pem(options['privateKey'])\n                }))\n            }\n\n            ds.options = json.dumps(new_options)\n            ds.save(only=ds.dirty_fields)\n        elif ds.type == 'google_spreadsheets':\n            options = json.loads(ds.options)\n            if 'jsonKeyFile' in options:\n                continue\n\n            with open(options['credentialsFilePath']) as f:\n                new_options = {\n                    'jsonKeyFile': b64encode(f.read())\n                }\n\n            ds.options = json.dumps(new_options)\n            ds.save(only=ds.dirty_fields)\n", "comments": "", "content": "from base64 import b64encode\nimport json\nfrom redash.models import DataSource\n\n\ndef convert_p12_to_pem(p12file):\n    from OpenSSL import crypto\n    with open(p12file, 'rb') as f:\n        p12 = crypto.load_pkcs12(f.read(), \"notasecret\")\n\n    return crypto.dump_privatekey(crypto.FILETYPE_PEM, p12.get_privatekey())\n\nif __name__ == '__main__':\n\n    for ds in DataSource.select(DataSource.id, DataSource.type, DataSource.options):\n\n        if ds.type == 'bigquery':\n            options = json.loads(ds.options)\n\n            if 'jsonKeyFile' in options:\n                continue\n\n            new_options = {\n                'projectId': options['projectId'],\n                'jsonKeyFile': b64encode(json.dumps({\n                    'client_email': options['serviceAccount'],\n                    'private_key': convert_p12_to_pem(options['privateKey'])\n                }))\n            }\n\n            ds.options = json.dumps(new_options)\n            ds.save(only=ds.dirty_fields)\n        elif ds.type == 'google_spreadsheets':\n            options = json.loads(ds.options)\n            if 'jsonKeyFile' in options:\n                continue\n\n            with open(options['credentialsFilePath']) as f:\n                new_options = {\n                    'jsonKeyFile': b64encode(f.read())\n                }\n\n            ds.options = json.dumps(new_options)\n            ds.save(only=ds.dirty_fields)\n", "description": "Make Your Company Data Driven. Connect to any data source, easily visualize and share your data.", "file_name": "0011_migrate_bigquery_to_json.py", "id": "bf78b2d37f09fd52efe6a3d362c72389", "language": "Python", "project_name": "redash", "quality": "", "save_path": "/home/ubuntu/test_files/clean/python/getredash-redash/getredash-redash-0410d83/old_migrations/0011_migrate_bigquery_to_json.py", "save_time": "", "source": "", "update_at": "2018-03-18T12:54:55Z", "url": "https://github.com/getredash/redash", "wiki": false}